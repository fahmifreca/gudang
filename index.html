<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Gudang Data - Inventaris</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lexend:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .font-lexend {
            font-family: 'Lexend', sans-serif;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .nav-link {
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .nav-link:hover {
            background-color: #004a7c;
        }
        .nav-link.active {
            background-color: #0060a1;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .nav-link.active svg {
            color: white;
        }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            border-width: 1px;
            border-color: #f1f5f9;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            padding: 1.5rem;
        }
        /* Style untuk loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800">
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-50 via-white to-white p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-xl border border-slate-200">
            <div class="flex justify-center">
                 <img id="login-logo" src="https://gudang.frecagroup.id/logofreca.png" alt="Logo Perusahaan" class="h-16 mb-4 object-contain" onerror="this.src='https://placehold.co/128x80/e0e0e0/333?text=Logo'">
            </div>
            <h1 id="login-title" class="text-3xl font-bold text-center text-slate-800">Data Gudang Login</h1>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-slate-700">Email</label>
                    <input type="email" id="email" required class="w-full px-4 py-3 mt-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                </div>
                <div class="relative">
                    <label for="password" class="text-sm font-medium text-slate-700">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 mt-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    <span class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 cursor-pointer password-toggle">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </span>
                </div>
                <button type="submit" id="login-btn" class="w-full py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all shadow-lg shadow-indigo-500/30 hover:shadow-xl hover:shadow-indigo-500/40">Login</button>
                 <p class="text-center text-sm text-slate-600">
                    Belum punya akun? <a href="#" id="show-register-form" class="font-medium text-indigo-600 hover:underline">Buat akun baru</a>
                </p>
            </form>
            
            <form id="register-form" class="hidden space-y-6">
                <div>
                    <label for="register-email" class="text-sm font-medium text-slate-700">Email</label>
                    <input type="email" id="register-email" required class="w-full px-4 py-3 mt-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                </div>
                <div class="relative">
                    <label for="register-password" class="text-sm font-medium text-slate-700">Password</label>
                    <input type="password" id="register-password" required class="w-full px-4 py-3 mt-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    <span class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 cursor-pointer password-toggle">
                       <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </span>
                </div>
                <button type="submit" class="w-full py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Daftar</button>
                 <p class="text-center text-sm text-slate-600">
                    Sudah punya akun? <a href="#" id="show-login-form" class="font-medium text-indigo-600 hover:underline">Login di sini</a>
                </p>
            </form>
        </div>
    </div>
    <div id="app-container" class="hidden">
        <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        <div class="relative flex h-screen overflow-hidden">
            <aside id="sidebar" class="fixed md:relative z-30 w-64 flex-col flex-shrink-0 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 md:flex h-screen" style="background-color: #002e4e;">
                <div class="flex flex-col items-center justify-center h-28 p-8 border-b border-sky-900 mb-4 mt-4">
                    <img id="sidebar-logo" src="https://gudang.frecagroup.id/logofreca.png" alt="Logo Perusahaan" class="h-16 mb-2 object-contain" onerror="this.src='https://placehold.co/128x64/e0e0e0/333?text=Logo'">
                    <span id="sidebar-title" class="text-xl font-bold text-white mb-2">Data Gudang</span>
                </div>
                <nav id="sidebar-nav" class="flex-1 px-4 py-4 space-y-2"></nav>
                <div class="px-4 py-4 border-t border-sky-900">
                    <a href="#" id="logout-btn" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium text-white hover:bg-red-500/80">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Logout
                    </a>
                </div>
            </aside>
            <main class="flex-1 flex flex-col overflow-hidden">
                <header class="md:hidden flex items-center justify-between p-4 bg-white border-b border-slate-200">
                    <button id="hamburger-btn" class="p-2 rounded-md text-slate-600 hover:bg-slate-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <span id="mobile-header-title" class="text-lg font-bold" style="color: #002e4e;">Data Gudang</span>
                    <div class="w-8"></div>
                </header>
                <div class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-8">
                    <div id="main-loader" class="flex flex-col items-center justify-center h-full">
                        <div class="loader"></div>
                        <p class="mt-4 text-slate-500">Memuat data...</p>
                    </div>
                    <div id="main-content" class="container mx-auto hidden">
                        <section id="page-dashboard" class="page"></section>
                        <section id="page-kalkulator" class="page"></section>
                        <section id="page-produksi" class="page"></section>
                        <section id="page-barang-keluar" class="page"></section>
                        <section id="page-input" class="page"></section>
                        <section id="page-master" class="page"></section>
                        <section id="page-laporan" class="page"></section>
                        <section id="page-admin" class="page"></section>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="notification" class="fixed top-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-50">
        <span id="notification-message"></span>
    </div>
    <div id="pin-modal" class="fixed inset-0 z-50 items-center justify-center hidden"> <div class="modal-backdrop fixed inset-0"></div> <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto z-10"> <h3 class="text-lg font-medium text-slate-900 mb-4">Verifikasi PIN</h3> <p class="text-sm text-slate-600 mb-4">Masukkan PIN untuk melanjutkan aksi ini.</p> <form id="pin-form"> <input type="password" id="pin-input" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" placeholder="Masukkan PIN"> <div class="mt-4 flex justify-end space-x-2"> <button type="button" id="cancel-pin-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Batal</button> <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Otorisasi</button> </div> </form> </div> </div>
    <div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-y-auto"> <div class="modal-backdrop fixed inset-0"></div> <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto z-10 my-8"> <h3 id="edit-modal-title" class="text-xl font-bold text-slate-900 mb-4">Edit Data</h3> <form id="edit-modal-form" class="space-y-4"></form> </div> </div>
    <div id="production-confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden"> <div class="modal-backdrop fixed inset-0"></div> <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto z-10"> <h3 class="text-xl font-bold text-slate-900 mb-4">Konfirmasi Produksi</h3> <p id="production-confirm-text" class="text-sm text-slate-600 mb-4"></p> <div id="production-confirm-materials" class="max-h-48 overflow-y-auto border rounded-lg p-3 space-y-2 mb-4"></div> <div class="mt-6 flex justify-end space-x-3"> <button type="button" id="cancel-production-btn" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-700">Batal</button> <button type="button" id="confirm-production-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Lanjut Produksi</button> </div> </div> </div>
    <script type="module">
        // Import fungsi yang diperlukan dari SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, updateDoc, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // KONFIGURASI FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyDeN2iDeRl8tQ1SfjewdDCYTxIK4aN24EM", authDomain: "gudang-freca.firebaseapp.com", projectId: "gudang-freca", storageBucket: "gudang-freca.appspot.com", messagingSenderId: "836230153184", appId: "1:836230153184:web:c3ef63610f6aa2f5996185", measurementId: "G-RMGPPZZDG7" };
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // STATE MANAGEMENT
        let rawMaterialsData = [], finishedGoodsData = [], productionHistory = [], goodsOutHistory = [], stockAddHistory = [], users = [], roles = [], recipes = [], appSettings = {};
        let currentUserRole = null, unsubscribeListeners = [], pendingAction = null, pendingProductionData = null, productionInputs = {};
        let productionPieChartInstance = null, goodsOutPieChartInstance = null, trendlineChartInstance = null;
        let pageContentLoaded = false; 
        // --- DOM ELEMENT VARIABLES ---
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutBtn = document.getElementById('logout-btn');
        const mainLoader = document.getElementById('main-loader');
        const mainContent = document.getElementById('main-content');
        
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        const showNotification = (message, isError = false) => { const notification = document.getElementById('notification'), messageEl = document.getElementById('notification-message'); messageEl.textContent = message; notification.className = `fixed top-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl transform transition-transform duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`; notification.classList.remove('translate-x-full'); setTimeout(() => { notification.classList.add('translate-x-full'); }, 3000); };
        const renderPageContent = () => {
            document.getElementById('page-dashboard').innerHTML = `<header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8"><div><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Dashboard</h1><p class="text-slate-500 mt-1">Ringkasan dan analisis data inventaris Anda.</p></div><div class="flex items-center gap-4 mt-4 sm:mt-0"><input type="date" id="start-date-dash" class="date-filter-start bg-white border-slate-300 rounded-md shadow-sm text-sm p-2"><span class="text-slate-500">to</span><input type="date" id="end-date-dash" class="date-filter-end bg-white border-slate-300 rounded-md shadow-sm text-sm p-2"></div></header><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" id="kpi-container"></div><div class="card mb-6"><h2 class="text-xl font-semibold mb-4 text-slate-800">Tren Aktivitas Gudang</h2><div class="relative h-80"><canvas id="trendlineChart"></canvas></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><div class="card"><h2 class="text-xl font-semibold mb-4 text-slate-800">Komposisi Produksi</h2><div class="relative h-72"><canvas id="productionPieChart"></canvas></div></div><div class="card"><h2 class="text-xl font-semibold mb-4 text-slate-800">Komposisi Barang Keluar</h2><div class="relative h-72"><canvas id="goodsOutPieChart"></canvas></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="card"><h2 class="text-xl font-semibold mb-4 text-slate-800">Stok Bahan Baku Teratas</h2><div class="overflow-y-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama</th><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Stok</th><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nilai</th></tr></thead><tbody id="dashboard-table-raw" class="divide-y divide-slate-100"></tbody></table></div></div><div class="card"><h2 class="text-xl font-semibold mb-4 text-slate-800">Stok Barang Jadi Teratas</h2><div class="overflow-y-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama</th><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Stok</th><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nilai (HPP)</th></tr></thead><tbody id="dashboard-table-finished" class="divide-y divide-slate-100"></tbody></table></div></div></div>`;
            document.getElementById('page-kalkulator').innerHTML = `<header class="mb-8"><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Kalkulator Produksi</h1><p class="text-slate-500 mt-1">Hitung kebutuhan bahan baku untuk rencana produksi Anda.</p></header><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 card h-fit"><form id="form-calculator" class="space-y-4"><div><label for="calc-fg-name" class="block text-sm font-medium text-slate-700">Pilih Produk Jadi</label><select id="calc-fg-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm"></select></div><div><label for="calc-quantity" class="block text-sm font-medium text-slate-700">Jumlah Rencana Produksi</label><input type="number" id="calc-quantity" min="1" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div><button type="submit" class="w-full bg-indigo-600 text-white py-2.5 px-4 rounded-md hover:bg-indigo-700 font-semibold">Hitung Kebutuhan</button></form></div><div class="lg:col-span-2 card"><h2 class="text-xl font-semibold mb-4 text-slate-800">Hasil Perhitungan</h2><div id="calculator-result-container"><p class="text-center text-slate-500">Silakan pilih produk dan isi jumlah untuk menghitung kebutuhan bahan baku.</p></div></div></div>`;
            document.getElementById('page-produksi').innerHTML = `<header class="mb-8"><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Produksi Barang Jadi</h1><p class="text-slate-500 mt-1">Pilih produk, tentukan jumlah, dan masukkan bahan baku yang digunakan.</p></header><form id="form-produksi" class="card max-w-4xl mx-auto space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><label for="prod-fg-name" class="block text-sm font-medium text-slate-700">1. Pilih Produk Jadi</label><select id="prod-fg-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm"></select></div><div class="md:col-span-1"><label for="prod-quantity" class="block text-sm font-medium text-slate-700">2. Jumlah Produksi</label><input type="number" id="prod-quantity" min="1" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div><div class="md:col-span-1"><label for="prod-date" class="block text-sm font-medium text-slate-700">3. Tanggal Produksi</label><input type="date" id="prod-date" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div></div><div><h3 class="text-lg font-medium text-slate-900 border-b border-slate-200 pb-2 mb-4">4. Pilih Bahan Baku yang Digunakan</h3><input type="text" id="search-prod-raw-material" placeholder="Cari bahan baku..." class="w-full px-3 py-2 mb-4 border border-slate-300 rounded-md shadow-sm"><div id="raw-material-selection-container" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div></div><button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 transition-colors font-semibold">PRODUKSI</button></form>`;
            document.getElementById('page-barang-keluar').innerHTML = `<header class="mb-8"><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Catat Barang Keluar</h1><p class="text-slate-500 mt-1">Mengurangi stok barang jadi untuk penjualan atau pengiriman.</p></header><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><form id="form-barang-keluar" class="lg:col-span-1 card space-y-4 h-fit"><input type="hidden" id="g-out-edit-id"><input type="hidden" id="g-out-original-qty"><input type="hidden" id="g-out-original-product-id"><div><label for="out-date" class="block text-sm font-medium text-slate-700">Tanggal Keluar</label><input type="date" id="out-date" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div><div><label for="out-fg-name" class="block text-sm font-medium text-slate-700">Pilih Produk</label><select id="out-fg-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm"></select></div><div><label for="out-quantity" class="block text-sm font-medium text-slate-700">Jumlah Keluar</label><input type="number" id="out-quantity" min="1" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div><button type="submit" id="g-out-submit-btn" class="w-full bg-red-600 text-white py-2.5 px-4 rounded-md hover:bg-red-700 transition-colors font-semibold">CATAT PENGELUARAN</button></form><div class="lg:col-span-2 card"><h2 class="text-xl font-semibold mb-4 text-slate-800">Riwayat Barang Keluar</h2><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Tanggal</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama Produk</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Jumlah</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="table-goods-out-history" class="bg-white divide-y divide-slate-100"></tbody></table></div></div></div>`;
            document.getElementById('page-input').innerHTML = `<header class="mb-8"><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Input & Master Item</h1><p class="text-slate-500 mt-1">Daftarkan item baru, atur resep, kemudian tambahkan stoknya.</p></header><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-8"><div class="card"><h2 class="text-xl font-semibold mb-4 border-b border-slate-200 pb-2 text-slate-800">1. Daftarkan Bahan Baku Baru</h2><form id="form-define-raw-material" class="grid grid-cols-3 gap-4 items-end"><div class="col-span-2"><label for="define-rm-name" class="block text-sm font-medium">Nama Bahan Baku</label><input type="text" id="define-rm-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="define-rm-unit" class="block text-sm font-medium">Satuan</label><input type="text" id="define-rm-unit" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><button type="submit" class="col-span-3 w-full bg-purple-600 text-white py-2.5 px-4 rounded-md hover:bg-purple-700 font-semibold">Daftarkan Bahan</button></form><h3 class="text-lg font-medium text-slate-800 mt-6 mb-2">Daftar Bahan Baku</h3><div id="list-defined-raw-materials" class="max-h-48 overflow-y-auto border rounded-lg p-2 bg-slate-50"></div></div><div class="card"><h2 class="text-xl font-semibold mb-4 border-b border-slate-200 pb-2 text-slate-800">2. Daftarkan Barang Jadi Baru</h2><form id="form-define-finished-good" class="grid grid-cols-3 gap-4 items-end"><div class="col-span-2"><label for="define-fg-name" class="block text-sm font-medium">Nama Barang Jadi</label><input type="text" id="define-fg-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><button type="submit" class="col-span-1 w-full bg-purple-600 text-white py-2.5 px-4 rounded-md hover:bg-purple-700 font-semibold">Daftarkan</button></form><h3 class="text-lg font-medium text-slate-800 mt-6 mb-2">Daftar Barang Jadi</h3><div id="list-defined-finished-goods" class="max-h-48 overflow-y-auto border rounded-lg p-2 bg-slate-50"></div></div></div><div class="space-y-8"><div class="card"><h2 class="text-xl font-semibold mb-4 border-b border-slate-200 pb-2 text-slate-800">3. Atur Resep Produksi</h2><form id="form-recipe" class="space-y-4"><label for="recipe-fg-name" class="block text-sm font-medium">Pilih Produk Jadi</label><select id="recipe-fg-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md bg-white"></select><input type="text" id="search-recipe-raw-material" placeholder="Cari bahan baku..." class="w-full px-3 py-2 mt-4 border border-slate-300 rounded-md shadow-sm"><div id="recipe-materials-container" class="max-h-60 overflow-y-auto space-y-2 mt-2 border-t pt-4"></div><button type="submit" class="w-full bg-teal-600 text-white py-2.5 px-4 rounded-md hover:bg-teal-700 font-semibold">Simpan Resep</button></form></div><div class="card"><h2 class="text-xl font-semibold mb-4 border-b border-slate-200 pb-2 text-slate-800">4. Tambah Stok</h2><div id="add-stock-tabs" class="mb-4 border-b border-gray-200"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><button data-tab="raw" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">Bahan Baku</button><button data-tab="finished" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Barang Jadi</button></nav></div><div id="tab-content-raw"><form id="form-add-stock-raw-material" class="space-y-4"></form></div><div id="tab-content-finished" class="hidden"><form id="form-add-stock-finished-good" class="space-y-4"></form></div></div></div></div><div class="mt-8 card"><h2 class="text-xl font-semibold text-slate-800 mb-4">Lihat Resep Produksi</h2><div><select id="recipe-lookup-select" class="w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm"></select><div id="recipe-lookup-details" class="mt-4 p-4 border rounded-md bg-slate-50 min-h-[100px]"></div></div></div>`;
            document.getElementById('page-master').innerHTML = `<header class="mb-8"><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Master Data</h1><p class="text-slate-500 mt-1">Lihat dan kelola semua data inventaris</p></header><div class="space-y-8"><div class="card"><div class="flex flex-col sm:flex-row justify-between items-center mb-4"><h2 class="text-xl font-semibold text-slate-800 mb-2 sm:mb-0">Data Bahan Baku</h2><div class="flex items-center gap-4"><input type="text" id="search-raw" placeholder="Cari bahan baku..." class="search-input w-full sm:w-64 px-4 py-2 border border-slate-300 rounded-lg"><button id="export-raw-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold">Export Excel</button></div></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama Item</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Stok</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Harga Rata-rata</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nilai Stok</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="table-raw-materials" class="bg-white divide-y divide-slate-100"></tbody></table></div></div><div class="card"><div class="flex flex-col sm:flex-row justify-between items-center mb-4"><h2 class="text-xl font-semibold text-slate-800 mb-2 sm:mb-0">Data Barang Jadi</h2><div class="flex items-center gap-4"><input type="text" id="search-finished" placeholder="Cari barang jadi..." class="search-input w-full sm:w-64 px-4 py-2 border border-slate-300 rounded-lg"><button id="export-finished-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold">Export Excel</button></div></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama Produk</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Stok</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">HPP Rata-rata</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Harga Jual</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nilai Stok (HPP)</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="table-finished-goods" class="bg-white divide-y divide-slate-100"></tbody></table></div></div></div>`;
            document.getElementById('page-laporan').innerHTML = `<header class="mb-8"><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Laporan</h1><p class="text-slate-500 mt-1">Analisis produksi, penjualan, dan profitabilitas.</p></header><div class="card mb-6 flex flex-col sm:flex-row items-center gap-4"><label class="font-medium text-slate-700">Filter Tanggal:</label><input type="date" id="start-date-laporan" class="date-filter-start bg-white border-slate-300 rounded-md shadow-sm"><span class="text-slate-500">hingga</span><input type="date" id="end-date-laporan" class="date-filter-end bg-white border-slate-300 rounded-md shadow-sm"></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="report-summary-container"></div><div class="space-y-8"><div class="card"><h2 class="text-xl font-semibold text-slate-800 mb-4">Laporan Input Data</h2><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Tanggal</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama Barang</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Supplier</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Jumlah</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Harga Satuan</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nilai Total</th></tr></thead><tbody id="table-report-stock-add" class="bg-white divide-y divide-slate-100"></tbody></table></div></div><div class="card"><h2 class="text-xl font-semibold text-slate-800 mb-4">Laporan Produksi</h2><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Tanggal</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama Produk</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Jumlah</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Biaya Produksi</th></tr></thead><tbody id="table-report-production" class="bg-white divide-y divide-slate-100"></tbody></table></div></div><div class="card"><h2 class="text-xl font-semibold text-slate-800 mb-4">Laporan Barang Keluar (Penjualan)</h2><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Tanggal</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama Produk</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Jumlah</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Total HPP</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Penjualan</th><th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Estimasi Laba</th></tr></thead><tbody id="table-report-goods-out" class="bg-white divide-y divide-slate-100"></tbody></table></div></div></div>`;
            document.getElementById('page-admin').innerHTML = `<header class="mb-8"><h1 class="font-lexend text-4xl font-bold text-slate-900 tracking-tight">Admin</h1><p class="text-slate-500 mt-1">Kelola pengguna, peran, dan pengaturan aplikasi.</p></header><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="card space-y-6"><div><h2 class="text-xl font-semibold mb-4 border-b border-slate-200 pb-2 text-slate-800">Manajemen Peran (Role)</h2><form id="form-add-role" class="space-y-4 mb-4"><input type="text" id="new-role-name" placeholder="Nama Peran Baru" required class="w-full border border-slate-300 rounded-md p-2"><div id="role-permissions" class="grid grid-cols-2 gap-2 text-sm"></div><button type="submit" class="w-full bg-purple-600 text-white py-2.5 rounded-md hover:bg-purple-700 font-semibold">Tambah Peran</button></form><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Nama Peran</th><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="table-roles" class="bg-white divide-y divide-slate-100"></tbody></table></div></div><div><h2 class="text-xl font-semibold mb-4 border-b border-slate-200 pb-2 text-slate-800">Manajemen Pengguna</h2><form id="form-add-user" class="grid grid-cols-2 gap-4 mb-4 items-end"><div class="col-span-2"><label for="new-user-email" class="block text-sm font-medium text-slate-700">Email Pengguna</label><input type="email" id="new-user-email" required class="mt-1 w-full border border-slate-300 rounded-md p-2"></div><div class="col-span-2 sm:col-span-1"><label for="new-user-password" class="block text-sm font-medium text-slate-700">Password</label><input type="password" id="new-user-password" required class="mt-1 w-full border border-slate-300 rounded-md p-2"></div><div class="col-span-2 sm:col-span-1"><label for="new-user-role" class="block text-sm font-medium text-slate-700">Role</label><select id="new-user-role" class="mt-1 w-full border border-slate-300 rounded-md p-2 bg-white h-[42px]"></select></div><div class="col-span-2"><button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-md hover:bg-indigo-700 font-semibold">Tambah Pengguna</button></div></form><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Email</th><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Role</th><th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="table-users" class="bg-white divide-y divide-slate-100"></tbody></table></div></div></div><div class="card h-fit"><h2 class="text-xl font-semibold mb-4 border-b border-slate-200 pb-2 text-slate-800">Pengaturan Aplikasi</h2><form id="form-app-settings" class="space-y-4"><div><label for="setting-title" class="block text-sm font-medium">Judul Aplikasi</label><input type="text" id="setting-title" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="setting-logo-url" class="block text-sm font-medium">URL Logo</label><input type="text" id="setting-logo-url" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><button type="submit" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-md hover:bg-green-700 font-semibold">Simpan Pengaturan</button></form></div></div>`;
            
            populateForms();
            addEventListeners();
        };
        const populateForms = () => {
            document.getElementById('form-add-stock-raw-material').innerHTML = `<div><label for="add-rm-name" class="block text-sm font-medium">Pilih Bahan Baku</label><select id="add-rm-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md bg-white"></select></div><div class="grid grid-cols-2 gap-4"><div><label for="add-rm-stock" class="block text-sm font-medium">Jumlah Stok</label><input type="number" id="add-rm-stock" min="0" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="add-rm-price" class="block text-sm font-medium">Harga Beli Satuan</label><input type="number" min="0" id="add-rm-price" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div></div><div><label for="add-rm-supplier" class="block text-sm font-medium">Supplier</label><input type="text" id="add-rm-supplier" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><button type="submit" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-md hover:bg-blue-700 font-semibold">Tambah Stok</button>`;
            document.getElementById('form-add-stock-finished-good').innerHTML = `<div><label for="add-fg-name" class="block text-sm font-medium">Pilih Barang Jadi</label><select id="add-fg-name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md bg-white"></select></div><div class="grid grid-cols-2 gap-4"><div><label for="add-fg-stock" class="block text-sm font-medium">Jumlah Stok</label><input type="number" min="0" id="add-fg-stock" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="add-fg-hpp" class="block text-sm font-medium">HPP Satuan</label><input type="number" min="0" id="add-fg-hpp" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div></div><div class="grid grid-cols-2 gap-4"><div><label for="add-fg-price" class="block text-sm font-medium">Harga Jual</label><input type="number" min="0" id="add-fg-price" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="add-fg-location" class="block text-sm font-medium">Lokasi Gudang</label><input type="text" id="add-fg-location" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></div></div><button type="submit" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-md hover:bg-green-700 font-semibold">Tambah Stok</button>`;
        };
        const populateDynamicDropdowns = () => { const prodSelect = document.getElementById('prod-fg-name'); const addRmSelect = document.getElementById('add-rm-name'); const addFgSelect = document.getElementById('add-fg-name'); const recipeFgSelect = document.getElementById('recipe-fg-name'); const calcFgSelect = document.getElementById('calc-fg-name'); const sortedRawMaterials = [...rawMaterialsData].sort((a, b) => a.name.localeCompare(b.name)); const sortedFinishedGoods = [...finishedGoodsData].sort((a, b) => a.name.localeCompare(b.name)); if (addRmSelect) addRmSelect.innerHTML = '<option value="">-- Pilih Bahan --</option>' + sortedRawMaterials.map(item => `<option value="${item.id}">${item.name}</option>`).join(''); if (addFgSelect) addFgSelect.innerHTML = '<option value="">-- Pilih Produk --</option>' + sortedFinishedGoods.map(item => `<option value="${item.id}">${item.name}</option>`).join(''); if (recipeFgSelect) recipeFgSelect.innerHTML = '<option value="">-- Pilih Produk --</option>' + sortedFinishedGoods.map(item => `<option value="${item.id}">${item.name}</option>`).join(''); if (calcFgSelect) calcFgSelect.innerHTML = '<option value="">-- Pilih Produk --</option>' + sortedFinishedGoods.map(item => `<option value="${item.id}">${item.name}</option>`).join(''); if (prodSelect) prodSelect.innerHTML = '<option value="">-- Pilih Produk --</option>' + sortedFinishedGoods.map(item => `<option value="${item.id}">${item.name}</option>`).join(''); if (document.getElementById('page-produksi')?.classList.contains('active')) renderProductionRawMaterials(); const outSelect = document.getElementById('out-fg-name'); if (outSelect) outSelect.innerHTML = '<option value="">-- Pilih Produk --</option>' + sortedFinishedGoods.map(item => `<option value="${item.id}">${item.name} (Stok: ${item.stock})</option>`).join(''); };
        const renderProductionRawMaterials = (searchTerm = '') => { const rmContainer = document.getElementById('raw-material-selection-container'); if (!rmContainer) return; const lowerCaseSearchTerm = searchTerm.toLowerCase(); const filteredMaterials = rawMaterialsData.filter(rm => rm.name.toLowerCase().includes(lowerCaseSearchTerm)); rmContainer.innerHTML = filteredMaterials.map(rm => { const currentValue = productionInputs[rm.id] || ''; return `<div class="grid grid-cols-3 gap-4 items-center"><label class="text-sm text-slate-600 col-span-1">${rm.name}</label><span class="text-xs text-slate-500 text-right">Stok: ${rm.stock.toLocaleString('id-ID')} ${rm.unit}</span><input type="number" min="0" value="${currentValue}" data-rm-id="${rm.id}" placeholder="Jumlah" class="col-span-1 block w-full px-2 py-1 border border-slate-300 rounded-md text-sm production-rm-input"></div>` }).join('') || `<p class="text-center text-slate-500 text-sm">Bahan baku tidak ditemukan.</p>`; };
        const applyFiltersAndRender = () => {
            const activePageId = document.querySelector('.page.active')?.id;
            if (!activePageId) return;
            const isDashboard = activePageId === 'page-dashboard';
            const isLaporan = activePageId === 'page-laporan';
            const startDate = document.getElementById(isDashboard ? 'start-date-dash' : 'start-date-laporan')?.value;
            const endDate = document.getElementById(isDashboard ? 'end-date-dash' : 'end-date-laporan')?.value;
            const filteredProduction = filterByDateRange(productionHistory, 'date', startDate, endDate);
            const filteredGoodsOut = filterByDateRange(goodsOutHistory, 'date', startDate, endDate);
            const filteredStockAdd = filterByDateRange(stockAddHistory, 'date', startDate, endDate);
            if (isDashboard) renderDashboard(filteredProduction, filteredGoodsOut, filteredStockAdd);
            if (isLaporan) renderReportsPage(filteredProduction, filteredGoodsOut, filteredStockAdd);
            if (activePageId === 'page-barang-keluar') renderGoodsOutHistoryTable();
            if(activePageId === 'page-admin') renderAdminPage();
            if (activePageId === 'page-input') {
                renderDefinedItemsLists();
                setupRecipeLookup();
                displayRecipeDetails();
            }
            
            if (activePageId === 'page-master') {
                const rawSearchTerm = document.getElementById('search-raw').value.toLowerCase();
                const finishedSearchTerm = document.getElementById('search-finished').value.toLowerCase();
                const filteredRaw = rawMaterialsData.filter(item => Object.values(item).join(' ').toLowerCase().includes(rawSearchTerm));
                const filteredFinished = finishedGoodsData.filter(item => Object.values(item).join(' ').toLowerCase().includes(finishedSearchTerm));
                const limitedRaw = filteredRaw.slice(0, 50);
                const limitedFinished = filteredFinished.slice(0, 50);
                renderRawMaterialsTable(limitedRaw);
                renderFinishedGoodsTable(limitedFinished);
            }
        };
        const renderDashboard = (filteredProduction, filteredGoodsOut, filteredStockAdd) => { updateKPIs(); renderPieCharts(filteredProduction, filteredGoodsOut); renderDashboardTables(rawMaterialsData, finishedGoodsData); renderTrendlineChart(filteredProduction, filteredGoodsOut, filteredStockAdd); }
        const filterByDateRange = (data, dateField, startDate, endDate) => { if (!startDate && !endDate) return data; return data.filter(item => { const itemDate = item[dateField]; const startMatch = startDate ? itemDate >= startDate : true; const endMatch = endDate ? itemDate <= endDate : true; return startMatch && endMatch; }); };
        const renderRawMaterialsTable = (data) => { const tableBody = document.getElementById('table-raw-materials'); if (tableBody) tableBody.innerHTML = data.map(item => `<tr class="hover:bg-slate-50"><td class="px-6 py-4 text-sm text-slate-700">${item.name}</td><td class="px-6 py-4 text-sm text-slate-700">${item.stock.toLocaleString('id-ID')} ${item.unit}</td><td class="px-6 py-4 text-sm text-slate-700">${formatRupiah(item.price)}</td><td class="px-6 py-4 text-sm font-medium text-slate-800">${formatRupiah(item.stock * item.price)}</td><td class="px-6 py-4 text-sm space-x-2"><button class="edit-item-btn px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700" data-collection="rawMaterials" data-id="${item.id}">Edit</button><button class="delete-rm-btn px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700" data-id="${item.id}">Hapus</button></td></tr>`).join('') || `<tr><td colspan="5" class="text-center py-4 text-slate-500">Data tidak ditemukan.</td></tr>`; };
        const renderFinishedGoodsTable = (data) => { const tableBody = document.getElementById('table-finished-goods'); if (tableBody) tableBody.innerHTML = data.map(item => `<tr class="hover:bg-slate-50"><td class="px-6 py-4 text-sm text-slate-700">${item.name}</td><td class="px-6 py-4 text-sm text-slate-700">${item.stock.toLocaleString('id-ID')}</td><td class="px-6 py-4 text-sm text-slate-700">${formatRupiah(item.hpp)}</td><td class="px-6 py-4 text-sm text-slate-700">${formatRupiah(item.price)}</td><td class="px-6 py-4 text-sm font-medium text-slate-800">${formatRupiah(item.stock * item.hpp)}</td><td class="px-6 py-4 text-sm space-x-2"><button class="edit-item-btn px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700" data-collection="finishedGoods" data-id="${item.id}">Edit</button><button class="delete-fg-btn px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700" data-id="${item.id}">Hapus</button></td></tr>`).join('') || `<tr><td colspan="6" class="text-center py-4 text-slate-500">Data tidak ditemukan.</td></tr>`; };
        
        // ### FUNGSI-FUNGSI BARU UNTUK DROPDOWN RESEP ###
        const setupRecipeLookup = () => {
            const select = document.getElementById('recipe-lookup-select');
            if (!select) return;

            // Ambil hanya produk yang punya resep
            const productsWithRecipes = finishedGoodsData.filter(fg => recipes.some(r => r.id === fg.id));

            let optionsHTML = '<option value="">-- Pilih Produk untuk Lihat Resep --</option>';
            productsWithRecipes.forEach(product => {
                optionsHTML += `<option value="${product.id}">${product.name}</option>`;
            });
            select.innerHTML = optionsHTML;
        };

        const displayRecipeDetails = () => {
            const select = document.getElementById('recipe-lookup-select');
            const detailsContainer = document.getElementById('recipe-lookup-details');
            if (!select || !detailsContainer) return;

            const selectedProductId = select.value;

            if (!selectedProductId) {
                detailsContainer.innerHTML = '<p class="text-center text-slate-500">Silakan pilih produk untuk melihat resepnya.</p>';
                return;
            }

            const selectedRecipe = recipes.find(r => r.id === selectedProductId);
            const materials = selectedRecipe?.materials || {};
            const materialEntries = Object.entries(materials);

            if (materialEntries.length === 0) {
                detailsContainer.innerHTML = '<p class="text-center text-slate-500">Resep untuk produk ini masih kosong.</p>';
                return;
            }

            let detailsHTML = '<ul class="space-y-2 text-sm">';
            materialEntries.forEach(([rmId, quantity]) => {
                const material = rawMaterialsData.find(rm => rm.id === rmId);
                if (material) {
                    detailsHTML += `<li class="flex justify-between">
                        <span>${material.name}</span>
                        <span class="font-medium">${quantity} ${material.unit}</span>
                    </li>`;
                }
            });
            detailsHTML += '</ul>';
            detailsContainer.innerHTML = detailsHTML;
        };
        
        const renderGoodsOutHistoryTable = () => { const tableBody = document.getElementById('table-goods-out-history'); if(tableBody) { const sortedHistory = [...goodsOutHistory].sort((a,b) => new Date(b.date) - new Date(a.date)); tableBody.innerHTML = sortedHistory.map(item => `<tr class="hover:bg-slate-50"><td class="px-6 py-4 text-sm text-slate-700">${item.date}</td><td class="px-6 py-4 text-sm text-slate-700">${item.productName}</td><td class="px-6 py-4 text-sm text-slate-700">${item.quantity.toLocaleString('id-ID')}</td><td class="px-6 py-4 text-sm space-x-2"><button class="edit-g-out-btn px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800" data-id="${item.id}">Edit</button><button class="delete-g-out-btn px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700" data-id="${item.id}">Hapus</button></td></tr>`).join('') || `<tr><td colspan="4" class="text-center py-4 text-slate-500">Belum ada riwayat barang keluar.</td></tr>`; } };
        const renderDashboardTables = (raw, finished) => { const rawBody = document.getElementById('dashboard-table-raw'); const finishedBody = document.getElementById('dashboard-table-finished'); if(rawBody && finishedBody) { const topRaw = [...raw].sort((a,b) => b.stock * b.price - a.stock * a.price).slice(0, 5); const topFinished = [...finished].sort((a,b) => b.stock * b.hpp - a.stock * a.hpp).slice(0, 5); rawBody.innerHTML = topRaw.map(item => `<tr class="hover:bg-slate-50"><td class="px-4 py-2 text-sm text-slate-700">${item.name}</td><td class="px-4 py-2 text-sm text-slate-700">${item.stock.toLocaleString('id-ID')} ${item.unit}</td><td class="px-4 py-2 text-sm font-medium text-slate-800">${formatRupiah(item.stock * item.price)}</td></tr>`).join('') || `<tr><td colspan="3" class="text-center py-4 text-slate-500">Data tidak ditemukan.</td></tr>`; finishedBody.innerHTML = topFinished.map(item => `<tr class="hover:bg-slate-50"><td class="px-4 py-2 text-sm text-slate-700">${item.name}</td><td class="px-4 py-2 text-sm text-slate-700">${item.stock.toLocaleString('id-ID')}</td><td class="px-4 py-2 text-sm font-medium text-slate-800">${formatRupiah(item.stock * item.hpp)}</td></tr>`).join('') || `<tr><td colspan="3" class="text-center py-4 text-slate-500">Data tidak ditemukan.</td></tr>`; } }
        const renderAdminPage = () => { const rolesTableBody = document.getElementById('table-roles'); const usersTableBody = document.getElementById('table-users'); const roleDropdown = document.getElementById('new-user-role'); const permissionsContainer = document.getElementById('role-permissions'); if(rolesTableBody) rolesTableBody.innerHTML = roles.map(role => `<tr class="hover:bg-slate-50"><td class="px-4 py-2 text-sm font-medium">${role.name}</td><td class="px-4 py-2 text-sm space-x-2">${role.name !== 'Admin' ? `<button class="edit-role-btn px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700" data-id="${role.id}">Edit</button><button class="delete-role-btn px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700" data-id="${role.id}">Hapus</button>` : '<span class="text-xs text-slate-500">Default Role</span>'}</td></tr>`).join(''); if(usersTableBody) usersTableBody.innerHTML = users.map(user => { const role = roles.find(r => r.id === user.roleId); return `<tr class="hover:bg-slate-50"><td class="px-4 py-2 text-sm text-slate-700">${user.email}</td><td class="px-4 py-2 text-sm text-slate-700">${role ? role.name : 'Tidak Diketahui'}</td><td class="px-4 py-2 text-sm space-x-2">${user.email !== auth.currentUser.email ? `<button class="edit-user-btn px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700" data-id="${user.id}">Edit</button><button class="delete-user-btn px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700" data-id="${user.id}">Hapus</button>` : '<span class="text-xs text-slate-500">Akun Anda</span>'}</td></tr>`}).join(''); if(roleDropdown) roleDropdown.innerHTML = roles.map(role => `<option value="${role.id}">${role.name}</option>`).join(''); if(permissionsContainer) { const pages = ['dashboard', 'kalkulator', 'produksi', 'barang-keluar', 'input', 'master', 'laporan', 'admin']; permissionsContainer.innerHTML = pages.map(page => `<label class="flex items-center space-x-2"><input type="checkbox" class="role-permission-cb rounded text-indigo-600 focus:ring-indigo-500" value="${page}"><span class="capitalize">${page.replace('-', ' ')}</span></label>`).join(''); } populateAppSettingsForm(); };
        const renderReportsPage = (filteredProduction, filteredGoodsOut, filteredStockAdd) => { const summaryContainer = document.getElementById('report-summary-container'); const productionBody = document.getElementById('table-report-production'); const goodsOutBody = document.getElementById('table-report-goods-out'); const stockAddBody = document.getElementById('table-report-stock-add'); if(!summaryContainer || !productionBody || !goodsOutBody || !stockAddBody) return; let totalHpp = 0, totalSales = 0; goodsOutBody.innerHTML = filteredGoodsOut.map(item => { const product = finishedGoodsData.find(p => p.name === item.productName); if(!product) return ''; const itemTotalHpp = item.quantity * product.hpp; const itemTotalSales = item.quantity * product.price; totalHpp += itemTotalHpp; totalSales += itemTotalSales; return `<tr class="hover:bg-slate-50"><td class="px-6 py-4 text-sm">${item.date}</td><td class="px-6 py-4 text-sm">${item.productName}</td><td class="px-6 py-4 text-sm">${item.quantity}</td><td class="px-6 py-4 text-sm">${formatRupiah(itemTotalHpp)}</td><td class="px-6 py-4 text-sm">${formatRupiah(itemTotalSales)}</td><td class="px-6 py-4 text-sm font-medium text-green-600">${formatRupiah(itemTotalSales - itemTotalHpp)}</td></tr>`; }).join(''); productionBody.innerHTML = filteredProduction.map(item => `<tr class="hover:bg-slate-50"><td class="px-6 py-4 text-sm">${item.date}</td><td class="px-6 py-4 text-sm">${item.productName}</td><td class="px-6 py-4 text-sm">${item.quantity}</td><td class="px-6 py-4 text-sm">${formatRupiah(item.totalCost)}</td></tr>`).join(''); stockAddBody.innerHTML = filteredStockAdd.map(item => `<tr class="hover:bg-slate-50"><td class="px-6 py-4 text-sm">${item.date}</td><td class="px-6 py-4 text-sm">${item.itemName}</td><td class="px-6 py-4 text-sm">${item.supplier || '-'}</td><td class="px-6 py-4 text-sm">${item.quantity}</td><td class="px-6 py-4 text-sm">${formatRupiah(item.price)}</td><td class="px-6 py-4 text-sm font-medium">${formatRupiah(item.quantity * item.price)}</td></tr>`).join(''); const grossProfit = totalSales - totalHpp; summaryContainer.innerHTML = `<div class="card"><p class="text-sm font-medium text-slate-500">Total Penjualan</p><p class="text-3xl font-bold text-blue-600">${formatRupiah(totalSales)}</p></div><div class="card"><p class="text-sm font-medium text-slate-500">Total HPP</p><p class="text-3xl font-bold text-red-600">${formatRupiah(totalHpp)}</p></div><div class="card"><p class="text-sm font-medium text-slate-500">Estimasi Laba Kotor</p><p class="text-3xl font-bold text-green-600">${formatRupiah(grossProfit)}</p></div>`; };
        const renderDefinedItemsLists = () => { const rmList = document.getElementById('list-defined-raw-materials'); const fgList = document.getElementById('list-defined-finished-goods'); if (rmList) rmList.innerHTML = rawMaterialsData.map(item => `<div class="text-sm p-2 bg-white rounded">${item.name} (${item.unit})</div>`).join('') || `<p class="text-center text-slate-500 text-sm">Belum ada bahan baku.</p>`; if (fgList) fgList.innerHTML = finishedGoodsData.map(item => `<div class="text-sm p-2 bg-white rounded">${item.name}</div>`).join('') || `<p class="text-center text-slate-500 text-sm">Belum ada barang jadi.</p>`; };
        const renderRecipeForm = (searchTerm = '') => { // <-- FUNGSI INI DIUBAH
            const fgId = document.getElementById('recipe-fg-name')?.value;
            const container = document.getElementById('recipe-materials-container');
            if (!container) return;
            if (!fgId) {
                container.innerHTML = '<p class="text-sm text-center text-slate-500">Pilih produk jadi untuk mengatur resepnya.</p>';
                return;
            }
            const recipe = recipes.find(r => r.id === fgId);
            const materials = recipe ? recipe.materials : {};
            
            // Logika filter ditambahkan di sini
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const sortedRawMaterials = [...rawMaterialsData].sort((a, b) => a.name.localeCompare(b.name));
            const filteredMaterials = sortedRawMaterials.filter(rm => rm.name.toLowerCase().includes(lowerCaseSearchTerm));

            container.innerHTML = filteredMaterials.map(rm => ` <div class="grid grid-cols-5 gap-2 items-center"> <label class="text-sm text-slate-600 col-span-3">${rm.name}</label> <input type="number" min="0" step="any" placeholder="Jumlah" data-rm-id="${rm.id}" value="${materials[rm.id] || ''}" class="recipe-input col-span-1 block w-full px-2 py-1 border border-slate-300 rounded-md text-sm"> <span class="text-sm text-slate-500 col-span-1">${rm.unit}</span> </div> `).join('') || '<p class="text-sm text-center text-slate-500">Bahan baku tidak ditemukan.</p>';
        };
        const populateAppSettingsForm = () => { const form = document.getElementById('form-app-settings'); if(form) { form.elements['setting-title'].value = appSettings.title || 'Data Gudang'; form.elements['setting-logo-url'].value = appSettings.logoUrl || ''; } };
        const updateKPIs = () => { const kpiContainer = document.getElementById('kpi-container'); if (kpiContainer) { const rawVal = rawMaterialsData.reduce((s, i) => s + (i.stock * i.price), 0); const finVal = finishedGoodsData.reduce((s, i) => s + (i.stock * i.hpp), 0); kpiContainer.innerHTML = `<div class="card"><p class="text-sm font-medium text-slate-500">Jenis Bahan Baku</p><p class="text-3xl font-bold">${rawMaterialsData.length}</p></div><div class="card"><p class="text-sm font-medium text-slate-500">Jenis Barang Jadi</p><p class="text-3xl font-bold">${finishedGoodsData.length}</p></div><div class="card"><p class="text-sm font-medium text-slate-500">Nilai Stok Bahan Baku</p><p class="text-3xl font-bold">${formatRupiah(rawVal)}</p></div><div class="card"><p class="text-sm font-medium text-slate-500">Nilai Stok Barang Jadi</p><p class="text-3xl font-bold">${formatRupiah(finVal)}</p></div>`; } };
        const renderPieCharts = (filteredProduction, filteredGoodsOut) => { const prodCtx = document.getElementById('productionPieChart')?.getContext('2d'); if(prodCtx) { if (productionPieChartInstance) productionPieChartInstance.destroy(); const prodSummary = filteredProduction.reduce((acc, curr) => { acc[curr.productName] = (acc[curr.productName] || 0) + curr.quantity; return acc; }, {}); productionPieChartInstance = new Chart(prodCtx, { type: 'pie', data: { labels: Object.keys(prodSummary), datasets: [{ data: Object.values(prodSummary), backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'] }] }, options: { responsive: true, maintainAspectRatio: false } }); } const goodsOutCtx = document.getElementById('goodsOutPieChart')?.getContext('2d'); if(goodsOutCtx) { if (goodsOutPieChartInstance) goodsOutPieChartInstance.destroy(); const goodsOutSummary = filteredGoodsOut.reduce((acc, curr) => { acc[curr.productName] = (acc[curr.productName] || 0) + curr.quantity; return acc; }, {}); goodsOutPieChartInstance = new Chart(goodsOutCtx, { type: 'pie', data: { labels: Object.keys(goodsOutSummary), datasets: [{ data: Object.values(goodsOutSummary), backgroundColor: ['#ef4444', '#8b5cf6', '#22c55e', '#eab308', '#06b6d4'] }] }, options: { responsive: true, maintainAspectRatio: false } }); } };
        const renderTrendlineChart = (filteredProduction, filteredGoodsOut, filteredStockAdd) => { const ctx = document.getElementById('trendlineChart')?.getContext('2d'); if (!ctx) return; const allDates = new Set([...filteredProduction.map(p => p.date), ...filteredGoodsOut.map(g => g.date), ...filteredStockAdd.filter(s => s.type === 'Bahan Baku').map(s => s.date)]); const labels = Array.from(allDates).sort(); const aggregateByDate = (data, valueField) => { const aggregated = data.reduce((acc, curr) => { acc[curr.date] = (acc[curr.date] || 0) + (valueField(curr)); return acc; }, {}); return labels.map(date => aggregated[date] || 0); }; const productionDataPoints = aggregateByDate(filteredProduction, item => item.quantity); const goodsOutDataPoints = aggregateByDate(filteredGoodsOut, item => item.quantity); const stockAddDataPoints = aggregateByDate(filteredStockAdd.filter(s => s.type === 'Bahan Baku'), item => item.quantity * item.price); if (trendlineChartInstance) trendlineChartInstance.destroy(); trendlineChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Jumlah Produksi', data: productionDataPoints, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4, yAxisID: 'y' }, { label: 'Jumlah Barang Keluar', data: goodsOutDataPoints, borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.1)', fill: true, tension: 0.4, yAxisID: 'y' }, { label: 'Nilai Pembelian Bahan', data: stockAddDataPoints, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, yAxisID: 'y1' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { type: 'linear', display: true, position: 'left', grid: { color: 'rgba(0, 0, 0, 0.05)' }, title: { display: true, text: 'Jumlah (Unit)' } }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Nilai (IDR)' } } }, plugins: { legend: { position: 'top' } }, interaction: { intersect: false, mode: 'index' } } }); };
        async function handleDefineRawMaterial(e) { e.preventDefault(); const form = e.target, name = form.elements['define-rm-name'].value, unit = form.elements['define-rm-unit'].value; if (rawMaterialsData.some(item => item.name.toLowerCase() === name.toLowerCase())) return showNotification(`Bahan baku '${name}' sudah ada.`, true); try { await addDoc(collection(db, 'rawMaterials'), { name, unit, stock: 0, price: 0 }); showNotification(`Bahan baku '${name}' berhasil didaftarkan.`); form.reset(); } catch (error) { showNotification("Gagal mendaftarkan bahan baku.", true); } };
        async function handleDefineFinishedGood(e) { e.preventDefault(); const form = e.target, name = form.elements['define-fg-name'].value; if (finishedGoodsData.some(item => item.name.toLowerCase() === name.toLowerCase())) return showNotification(`Barang jadi '${name}' sudah ada.`, true); try { await addDoc(collection(db, 'finishedGoods'), { name, stock: 0, hpp: 0, price: 0 }); showNotification(`Barang jadi '${name}' berhasil didaftarkan.`); form.reset(); } catch (error) { showNotification("Gagal mendaftarkan barang jadi.", true); } };
        async function handleAddStockRawMaterial(e) { e.preventDefault(); const form = e.target, id = form.elements['add-rm-name'].value, newStock = parseFloat(form.elements['add-rm-stock'].value), newPrice = parseFloat(form.elements['add-rm-price'].value), supplier = form.elements['add-rm-supplier'].value; if (!id) return showNotification('Silakan pilih bahan baku.', true); const item = rawMaterialsData.find(i => i.id === id); const totalStock = item.stock + newStock; const newAvgPrice = totalStock > 0 ? ((item.stock * item.price) + (newStock * newPrice)) / totalStock : newPrice; try { const batch = writeBatch(db); batch.update(doc(db, 'rawMaterials', id), { stock: totalStock, price: newAvgPrice }); batch.set(doc(collection(db, 'stockAddHistory')), { date: getTodayDate(), itemName: item.name, supplier, quantity: newStock, price: newPrice, type: 'Bahan Baku' }); await batch.commit(); showNotification(`Stok & harga untuk ${item.name} berhasil diperbarui.`); form.reset(); } catch (error) { showNotification("Gagal memperbarui stok.", true); } };
        async function handleAddStockFinishedGood(e) { e.preventDefault(); const form = e.target, id = form.elements['add-fg-name'].value, newStock = parseFloat(form.elements['add-fg-stock'].value), newHpp = parseFloat(form.elements['add-fg-hpp'].value), price = parseFloat(form.elements['add-fg-price'].value); if (!id) return showNotification('Silakan pilih barang jadi.', true); const item = finishedGoodsData.find(i => i.id === id); const totalStock = item.stock + newStock; const newAvgHpp = totalStock > 0 ? ((item.stock * item.hpp) + (newStock * newHpp)) / totalStock : newHpp; try { const batch = writeBatch(db); batch.update(doc(db, 'finishedGoods', id), { stock: totalStock, hpp: newAvgHpp, price }); batch.set(doc(collection(db, 'stockAddHistory')), { date: getTodayDate(), itemName: item.name, supplier: 'Produksi Internal', quantity: newStock, price: newHpp, type: 'Barang Jadi' }); await batch.commit(); showNotification(`Stok & HPP untuk ${item.name} berhasil diperbarui.`); form.reset(); } catch (error) { showNotification("Gagal memperbarui stok.", true); } };
        async function handleSaveRecipe(e) { e.preventDefault(); const form = e.target, fgId = form.elements['recipe-fg-name'].value; if (!fgId) return showNotification("Pilih produk jadi terlebih dahulu.", true); const materials = {}; document.querySelectorAll('.recipe-input').forEach(input => { const quantity = parseFloat(input.value); if (quantity > 0) materials[input.dataset.rmId] = quantity; }); try { await setDoc(doc(db, 'recipes', fgId), { materials }); showNotification("Resep berhasil disimpan."); } catch (error) { showNotification("Gagal menyimpan resep.", true); } };
        function handleCalculatorSubmit(e) { e.preventDefault(); const form = e.target, fgId = form.elements['calc-fg-name'].value, quantity = parseFloat(form.elements['calc-quantity'].value), resultContainer = document.getElementById('calculator-result-container'); if (!fgId || !quantity) { resultContainer.innerHTML = `<p class="text-center text-slate-500">Pilih produk dan isi jumlah produksi.</p>`; return; } const product = finishedGoodsData.find(p => p.id === fgId); const recipe = recipes.find(r => r.id === fgId); if (!recipe || Object.keys(recipe.materials).length === 0) { resultContainer.innerHTML = `<p class="text-center text-red-500">Resep untuk <strong>${product.name}</strong> belum diatur. Silakan atur di halaman <strong>Input Data</strong>.</p>`; return; } const resultsHTML = Object.entries(recipe.materials).map(([rmId, qtyPerUnit]) => { const rm = rawMaterialsData.find(r => r.id === rmId); if (!rm) return ''; const totalNeeded = qtyPerUnit * quantity; const isSufficient = rm.stock >= totalNeeded; const statusClass = isSufficient ? 'text-green-600' : 'text-red-600'; const statusText = isSufficient ? 'Cukup' : `Kurang ${(totalNeeded - rm.stock).toLocaleString('id-ID')}`; return `<tr class="border-b"><td class="py-2 px-3 text-sm text-slate-700">${rm.name}</td><td class="py-2 px-3 text-sm text-slate-700">${totalNeeded.toLocaleString('id-ID')} ${rm.unit}</td><td class="py-2 px-3 text-sm font-semibold ${statusClass}">${statusText}</td></tr>`; }).join(''); resultContainer.innerHTML = `<h3 class="text-lg font-medium text-slate-800 mb-2">Kebutuhan untuk ${quantity.toLocaleString('id-ID')} unit ${product.name}:</h3><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="py-2 px-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Bahan Baku</th><th class="py-2 px-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Jumlah Dibutuhkan</th><th class="py-2 px-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status Stok</th></tr></thead><tbody class="divide-y divide-slate-200">${resultsHTML}</tbody></table></div>`; };
        function handleProduksiSubmit(e) { e.preventDefault(); const form = e.target, date = form.elements['prod-date'].value || getTodayDate(), productId = form.elements['prod-fg-name'].value, quantity = parseInt(form.elements['prod-quantity'].value); if (!productId) return showNotification("Silakan pilih produk.", true); const materialsToDeduct = []; let totalMaterialCost = 0; for (const rmId in productionInputs) { const usedQty = parseFloat(productionInputs[rmId]); if (usedQty > 0) { const rm = rawMaterialsData.find(r => r.id === rmId); if (rm.stock < usedQty) return showNotification(`Stok ${rm.name} tidak cukup.`, true); materialsToDeduct.push({ material: rm, quantity: usedQty }); totalMaterialCost += usedQty * rm.price; } } if (materialsToDeduct.length === 0) return showNotification("Masukkan minimal satu bahan baku.", true); pendingProductionData = { date, productId, quantity, materialsToDeduct, totalMaterialCost }; const product = finishedGoodsData.find(p => p.id === productId); document.getElementById('production-confirm-text').textContent = `Anda yakin ingin memproduksi ${quantity} unit ${product.name}?`; document.getElementById('production-confirm-materials').innerHTML = materialsToDeduct.map(item => `<div class="text-sm text-slate-700">${item.material.name}: ${item.quantity} ${item.material.unit}</div>`).join(''); document.getElementById('production-confirm-modal').style.display = 'flex'; };
        async function executeProduction() { if (!pendingProductionData) return; const { date, productId, quantity, materialsToDeduct, totalMaterialCost } = pendingProductionData; try { const batch = writeBatch(db); const hppPerUnit = totalMaterialCost / quantity; materialsToDeduct.forEach(item => { batch.update(doc(db, 'rawMaterials', item.material.id), { stock: item.material.stock - item.quantity }); }); const fg = finishedGoodsData.find(f => f.id === productId); const totalStock = fg.stock + quantity; const newAvgHpp = totalStock > 0 ? ((fg.stock * fg.hpp) + (quantity * hppPerUnit)) / totalStock : hppPerUnit; batch.update(doc(db, 'finishedGoods', productId), { stock: totalStock, hpp: newAvgHpp }); batch.set(doc(collection(db, 'productionHistory')), { date, productName: fg.name, quantity, totalCost: totalMaterialCost }); await batch.commit(); showNotification(`Produksi ${quantity} unit ${fg.name} berhasil.`); document.getElementById('form-produksi').reset(); productionInputs = {}; } catch (error) { showNotification("Gagal memproses produksi.", true); } finally { pendingProductionData = null; document.getElementById('production-confirm-modal').style.display = 'none'; } };
        async function handleBarangKeluarSubmit(e) { e.preventDefault(); const form = e.target, date = form.elements['out-date'].value || getTodayDate(), productId = form.elements['out-fg-name'].value, quantity = parseInt(form.elements['out-quantity'].value), editId = form.elements['g-out-edit-id'].value; if (!productId) return showNotification("Silakan pilih produk.", true); try { const batch = writeBatch(db); if (editId) { const originalQty = parseInt(form.elements['g-out-original-qty'].value); const originalProductId = form.elements['g-out-original-product-id'].value; const qtyDiff = quantity - originalQty; if (originalProductId === productId) { const p = finishedGoodsData.find(i => i.id === productId); if (p.stock < qtyDiff) return showNotification(`Stok ${p.name} tidak cukup.`, true); batch.update(doc(db, 'finishedGoods', productId), { stock: p.stock - qtyDiff }); } else { const oldP = finishedGoodsData.find(i => i.id === originalProductId); const newP = finishedGoodsData.find(i => i.id === productId); if (newP.stock < quantity) return showNotification(`Stok ${newP.name} tidak mencukupi.`, true); batch.update(doc(db, 'finishedGoods', originalProductId), { stock: oldP.stock + originalQty }); batch.update(doc(db, 'finishedGoods', productId), { stock: newP.stock - quantity }); } const newName = finishedGoodsData.find(p => p.id === productId).name; batch.update(doc(db, 'goodsOutHistory', editId), { date, productId, productName: newName, quantity }); showNotification('Riwayat berhasil diperbarui.'); } else { const p = finishedGoodsData.find(i => i.id === productId); if (p.stock < quantity) return showNotification(`Stok ${p.name} tidak cukup.`, true); batch.update(doc(db, 'finishedGoods', productId), { stock: p.stock - quantity }); batch.set(doc(collection(db, 'goodsOutHistory')), { date, productId, productName: p.name, quantity }); showNotification(`${quantity} unit ${p.name} berhasil dicatat keluar.`); } await batch.commit(); resetBarangKeluarForm(); } catch (error) { showNotification("Gagal memproses barang keluar.", true); } };
        async function handleDeleteClick(collectionName, id) { if (confirm('Anda yakin ingin menghapus item ini?')) { try { await deleteDoc(doc(db, collectionName, id)); showNotification('Data berhasil dihapus.'); } catch (error) { showNotification("Gagal menghapus data.", true); } } };
        function handleEditItemClick(collectionName, id) { const modal = document.getElementById('edit-modal'), title = document.getElementById('edit-modal-title'), form = document.getElementById('edit-modal-form'); const baseInputClasses = "mt-1 block w-full px-3 py-2 border border-slate-300 bg-slate-50 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none"; let item; if (collectionName === 'rawMaterials') { item = rawMaterialsData.find(i => i.id === id); title.textContent = `Edit Data: ${item.name}`; form.innerHTML = `<input type="hidden" id="edit-id" value="${item.id}"><input type="hidden" id="edit-type" value="item"><input type="hidden" id="edit-collection" value="${collectionName}"><div><label for="edit-name" class="block text-sm font-medium">Nama</label><input type="text" id="edit-name" value="${item.name}" required class="${baseInputClasses}"></div><div><label for="edit-stock" class="block text-sm font-medium">Stok</label><input type="number" id="edit-stock" value="${item.stock}" required class="${baseInputClasses}"></div><div><label for="edit-price" class="block text-sm font-medium">Harga Rata-rata</label><input type="number" id="edit-price" value="${item.price}" required class="${baseInputClasses}"></div><div><label for="edit-unit" class="block text-sm font-medium">Satuan</label><input type="text" id="edit-unit" value="${item.unit}" required class="${baseInputClasses}"></div>`; } else if (collectionName === 'finishedGoods') { item = finishedGoodsData.find(i => i.id === id); title.textContent = `Edit Data: ${item.name}`; form.innerHTML = `<input type="hidden" id="edit-id" value="${item.id}"><input type="hidden" id="edit-type" value="item"><input type="hidden" id="edit-collection" value="${collectionName}"><div><label for="edit-name" class="block text-sm font-medium">Nama</label><input type="text" id="edit-name" value="${item.name}" required class="${baseInputClasses}"></div><div><label for="edit-stock" class="block text-sm font-medium">Stok</label><input type="number" id="edit-stock" value="${item.stock}" required class="${baseInputClasses}"></div><div><label for="edit-hpp" class="block text-sm font-medium">HPP Rata-rata</label><input type="number" id="edit-hpp" value="${item.hpp}" required class="${baseInputClasses}"></div><div><label for="edit-price" class="block text-sm font-medium">Harga Jual</label><input type="number" id="edit-price" value="${item.price}" required class="${baseInputClasses}"></div>`; } if (!item) return; form.innerHTML += `<div class="mt-4 flex justify-end space-x-2"><button type="button" id="edit-modal-cancel-btn" class="px-4 py-2 bg-slate-200 rounded-md">Batal</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Simpan</button></div>`; modal.style.display = 'flex'; };
        function handleEditGoodsOutClick(id) { const item = goodsOutHistory.find(i => i.id === id); if (!item) return; const form = document.getElementById('form-barang-keluar'); form.elements['g-out-edit-id'].value = item.id; form.elements['g-out-original-qty'].value = item.quantity; form.elements['g-out-original-product-id'].value = item.productId; form.elements['out-date'].value = item.date; form.elements['out-fg-name'].value = item.productId; form.elements['out-quantity'].value = item.quantity; document.getElementById('g-out-submit-btn').textContent = 'Update Pengeluaran'; document.getElementById('g-out-submit-btn').classList.replace('bg-red-600', 'bg-yellow-500'); };
        async function handleDeleteGoodsOutClick(id) { if (confirm('Menghapus riwayat ini akan mengembalikan stok barang. Lanjutkan?')) { const item = goodsOutHistory.find(i => i.id === id); if (!item) return showNotification('Data riwayat tidak ditemukan.', true); try { const batch = writeBatch(db); const p = finishedGoodsData.find(i => i.id === item.productId); if (p) { batch.update(doc(db, 'finishedGoods', item.productId), { stock: p.stock + item.quantity }); } batch.delete(doc(db, 'goodsOutHistory', id)); await batch.commit(); showNotification('Riwayat berhasil dihapus dan stok dikembalikan.'); } catch (error) { showNotification("Gagal menghapus riwayat.", true); } } };
        function handleEditUserClick(id) { const user = users.find(u => u.id === id); if (!user) return; const modal = document.getElementById('edit-modal'), title = document.getElementById('edit-modal-title'), form = document.getElementById('edit-modal-form'); title.textContent = `Edit Pengguna: ${user.email}`; const rolesOptions = roles.map(r => `<option value="${r.id}" ${user.roleId === r.id ? 'selected' : ''}>${r.name}</option>`).join(''); form.innerHTML = `<input type="hidden" id="edit-id" value="${user.id}"><input type="hidden" id="edit-type" value="user"><div><label for="edit-user-role" class="block text-sm font-medium">Peran</label><select id="edit-user-role" class="mt-1 block w-full rounded-md bg-white border border-slate-300 px-3 py-2">${rolesOptions}</select></div><div class="mt-4 flex justify-end space-x-2"><button type="button" id="edit-modal-cancel-btn" class="px-4 py-2 bg-slate-200 rounded-md">Batal</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Simpan</button></div>`; modal.style.display = 'flex'; };
        function handleEditRoleClick(id) { const role = roles.find(r => r.id === id); if (!role) return; const modal = document.getElementById('edit-modal'), title = document.getElementById('edit-modal-title'), form = document.getElementById('edit-modal-form'); title.textContent = `Edit Peran: ${role.name}`; const pages = ['dashboard', 'kalkulator', 'produksi', 'barang-keluar', 'input', 'master', 'laporan', 'admin']; const baseInputClasses = "mt-1 block w-full px-3 py-2 border border-slate-300 bg-slate-50 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none"; const checkboxes = pages.map(p => `<label class="flex items-center space-x-2"><input type="checkbox" class="role-permission-cb-edit rounded" value="${p}" ${role.access.includes(p) ? 'checked' : ''}><span class="capitalize">${p.replace('-', ' ')}</span></label>`).join(''); form.innerHTML = `<input type="hidden" id="edit-id" value="${role.id}"><input type="hidden" id="edit-type" value="role"><div><label for="edit-role-name" class="block text-sm font-medium">Nama Peran</label><input type="text" id="edit-role-name" value="${role.name}" required class="${baseInputClasses}"></div><div><label class="block text-sm font-medium mb-2">Hak Akses</label><div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${checkboxes}</div></div><div class="mt-4 flex justify-end space-x-2"><button type="button" id="edit-modal-cancel-btn" class="px-4 py-2 bg-slate-200 rounded-md">Batal</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Simpan</button></div>`; modal.style.display = 'flex'; };
        async function handleEditModalSubmit(e) { e.preventDefault(); const form = e.target, id = form.elements['edit-id'].value, type = form.elements['edit-type'].value; try { if (type === 'item') { const collectionName = form.elements['edit-collection'].value; let data = { name: form.elements['edit-name'].value, stock: parseFloat(form.elements['edit-stock'].value) }; if (collectionName === 'rawMaterials') { data.price = parseFloat(form.elements['edit-price'].value); data.unit = form.elements['edit-unit'].value; } else { data.hpp = parseFloat(form.elements['edit-hpp'].value); data.price = parseFloat(form.elements['edit-price'].value); } await updateDoc(doc(db, collectionName, id), data); } else if (type === 'user') { await updateDoc(doc(db, 'users', id), { roleId: form.elements['edit-user-role'].value }); } else if (type === 'role') { const access = Array.from(document.querySelectorAll('.role-permission-cb-edit:checked')).map(cb => cb.value); await updateDoc(doc(db, 'roles', id), { name: form.elements['edit-role-name'].value, access }); } showNotification("Data berhasil diperbarui."); } catch (error) { showNotification("Gagal memperbarui data.", true); } finally { document.getElementById('edit-modal').style.display = 'none'; } };
        function resetRawMaterialForm() { const form = document.getElementById('form-add-stock-raw-material'); if (form) form.reset(); };
        function resetFinishedGoodForm() { const form = document.getElementById('form-add-stock-finished-good'); if (form) form.reset(); };
        function resetBarangKeluarForm() { const form = document.getElementById('form-barang-keluar'); if (form) { form.reset(); form.elements['g-out-edit-id'].value = ''; form.elements['g-out-original-qty'].value = ''; form.elements['g-out-original-product-id'].value = ''; const btn = document.getElementById('g-out-submit-btn'); btn.textContent = 'CATAT PENGELUARAN'; btn.classList.replace('bg-yellow-500', 'bg-red-600'); } };
        
        async function handleAddUser(e) {
            e.preventDefault();
            const form = e.target;
            const email = form.elements['new-user-email'].value;
            const password = form.elements['new-user-password'].value;
            const roleId = form.elements['new-user-role'].value;

            if (!password || password.length < 6) {
                showNotification("Password harus diisi (minimal 6 karakter).", true);
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                if (userCredential.user) {
                    await addDoc(collection(db, 'users'), { email: email, roleId: roleId });
                    showNotification(`Pengguna ${email} berhasil dibuat dan ditambahkan.`);
                    form.reset();
                }
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showNotification(`Email ${email} sudah terdaftar.`, true);
                } else {
                    console.error("Error creating user:", error);
                    showNotification(`Gagal menambahkan pengguna. Error: ${error.message}`, true);
                }
            }
        }

        async function handleDeleteUser(id) { if (confirm('Hapus pengguna ini dari daftar peran? Ini tidak menghapus akun loginnya.')) { await deleteDoc(doc(db, 'users', id)); showNotification('Pengguna berhasil dihapus dari daftar peran.'); } };
        async function handleAddRole(e) { e.preventDefault(); const form = e.target, name = form.elements['new-role-name'].value; const access = Array.from(document.querySelectorAll('.role-permission-cb:checked')).map(cb => cb.value); await addDoc(collection(db, 'roles'), { name, access }); showNotification(`Peran '${name}' berhasil ditambahkan.`); form.reset(); };
        async function handleDeleteRole(id) { if (confirm('Hapus peran ini?')) { await deleteDoc(doc(db, 'roles', id)); showNotification('Peran berhasil dihapus.'); } };
        async function handleSaveSettings(e) { e.preventDefault(); const form = e.target, title = form.elements['setting-title'].value, logoUrl = form.elements['setting-logo-url'].value; try { await setDoc(doc(db, 'settings', 'appConfig'), { title, logoUrl }, { merge: true }); showNotification('Pengaturan berhasil disimpan.'); } catch (error) { showNotification("Gagal menyimpan pengaturan.", true); } };
        
        function addEventListeners() {
            document.querySelectorAll('.search-input, .date-filter-start, .date-filter-end').forEach(el => el.addEventListener('input', applyFiltersAndRender));
            document.getElementById('form-define-raw-material')?.addEventListener('submit', handleDefineRawMaterial);
            document.getElementById('form-define-finished-good')?.addEventListener('submit', handleDefineFinishedGood);
            document.getElementById('form-add-stock-raw-material')?.addEventListener('submit', handleAddStockRawMaterial);
            document.getElementById('form-add-stock-finished-good')?.addEventListener('submit', handleAddStockFinishedGood);
            document.getElementById('form-produksi')?.addEventListener('submit', handleProduksiSubmit);
            document.getElementById('form-barang-keluar')?.addEventListener('submit', handleBarangKeluarSubmit);
            document.getElementById('form-add-user')?.addEventListener('submit', handleAddUser);
            document.getElementById('form-add-role')?.addEventListener('submit', handleAddRole);
            document.getElementById('form-app-settings')?.addEventListener('submit', handleSaveSettings);
            document.getElementById('form-recipe')?.addEventListener('submit', handleSaveRecipe);
            
            document.getElementById('recipe-fg-name')?.addEventListener('change', () => {
                const searchInput = document.getElementById('search-recipe-raw-material');
                if (searchInput) {
                    searchInput.value = '';
                }
                renderRecipeForm();
            });

            document.getElementById('form-calculator')?.addEventListener('submit', handleCalculatorSubmit);
            document.getElementById('export-raw-btn')?.addEventListener('click', () => exportToExcel(rawMaterialsData, 'Bahan_Baku.xlsx'));
            document.getElementById('export-finished-btn')?.addEventListener('click', () => exportToExcel(finishedGoodsData, 'Barang_Jadi.xlsx'));
            document.getElementById('edit-modal-form').addEventListener('submit', handleEditModalSubmit);
            document.getElementById('add-stock-tabs')?.addEventListener('click', (e) => { if (e.target.classList.contains('tab-btn')) { const tabId = e.target.dataset.tab; document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('border-indigo-500', 'text-indigo-600'); btn.classList.add('border-transparent', 'text-gray-500'); }); e.target.classList.add('border-indigo-500', 'text-indigo-600'); document.getElementById('tab-content-raw').classList.add('hidden'); document.getElementById('tab-content-finished').classList.add('hidden'); document.getElementById(`tab-content-${tabId}`).classList.remove('hidden'); } });
            
            document.body.addEventListener('input', (e) => {
                if (e.target.matches('#search-prod-raw-material')) { renderProductionRawMaterials(e.target.value); }
                if (e.target.matches('.production-rm-input')) { productionInputs[e.target.dataset.rmId] = e.target.value; }
                if (e.target.matches('#search-recipe-raw-material')) { renderRecipeForm(e.target.value); }
            });

            // ### EVENT LISTENER BARU UNTUK DROPDOWN RESEP ###
            document.body.addEventListener('change', (e) => {
                 if (e.target.matches('#recipe-lookup-select')) {
                    displayRecipeDetails();
                }
            });
            
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.password-toggle')) { const i = e.target.closest('.relative').querySelector('input'); i.type = i.type === 'password' ? 'text' : 'password'; }
                if (e.target.matches('.delete-rm-btn')) showPinModal(() => handleDeleteClick('rawMaterials', e.target.dataset.id));
                if (e.target.matches('.edit-item-btn')) showPinModal(() => handleEditItemClick(e.target.dataset.collection, e.target.dataset.id));
                if (e.target.matches('.delete-fg-btn')) showPinModal(() => handleDeleteClick('finishedGoods', e.target.dataset.id));
                if (e.target.matches('.delete-g-out-btn')) showPinModal(() => handleDeleteGoodsOutClick(e.target.dataset.id));
                if (e.target.matches('.edit-g-out-btn')) showPinModal(() => handleEditGoodsOutClick(e.target.dataset.id));
                if (e.target.matches('.delete-user-btn')) handleDeleteUser(e.target.dataset.id);
                if (e.target.matches('.delete-role-btn')) handleDeleteRole(e.target.dataset.id);
                if (e.target.matches('.edit-user-btn')) handleEditUserClick(e.target.dataset.id);
                if (e.target.matches('.edit-role-btn')) handleEditRoleClick(e.target.dataset.id);
                if (e.target.matches('#edit-modal-cancel-btn')) { document.getElementById('edit-modal').style.display = 'none'; }
            });
        };
        function setupResponsiveSidebar() {
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            const navLinks = document.getElementById('sidebar-nav');
            const openSidebar = () => {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            };
            const closeSidebar = () => {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            };
            hamburgerBtn.addEventListener('click', openSidebar);
            backdrop.addEventListener('click', closeSidebar);
            
            document.getElementById('sidebar-close-btn')?.addEventListener('click', closeSidebar);
            
            navLinks.addEventListener('click', (e) => {
                if (e.target.closest('a') && window.innerWidth < 768) { 
                    closeSidebar();
                }
            });
        };
        
        // --- FUNGSI UTAMA OTENTIKASI & INISIALISASI ---
        async function handleLogin(e) { e.preventDefault(); const email = loginForm.elements.email.value, password = loginForm.elements.password.value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { showNotification("Email atau password salah.", true); } };
        async function handleRegister(e) { e.preventDefault(); const email = registerForm.elements['register-email'].value, password = registerForm.elements['register-password'].value; try { await createUserWithEmailAndPassword(auth, email, password); } catch (error) { showNotification(error.code === 'auth/email-already-in-use' ? "Email ini sudah terdaftar." : `Gagal mendaftar.`, true); } };
        function handleLogout() { signOut(auth); };
        function showApp() { loginPage.style.display = 'none'; appContainer.style.display = 'block'; };
        function showLogin() { loginPage.style.display = 'flex'; appContainer.style.display = 'none'; updateAppSettingsUI(); };
        function updateAppSettingsUI() { const title = appSettings.title || "Data Gudang"; const logoUrl = appSettings.logoUrl; document.getElementById('sidebar-title').textContent = title; document.getElementById('mobile-header-title').textContent = title; document.getElementById('login-title').textContent = `${title} Login`; if (logoUrl) { document.getElementById('sidebar-logo').src = logoUrl; document.getElementById('login-logo').src = logoUrl; } };
        function buildSidebarNav() { const navContainer = document.getElementById('sidebar-nav'); if (!currentUserRole) { navContainer.innerHTML = '<p class="px-4 text-sm text-gray-400">Tidak ada peran.</p>'; return; } const pageMap = { dashboard: `<a href="#dashboard" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a>`, kalkulator: `<a href="#kalkulator" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h.01M9 17h.01M12 17h.01M15 17h.01M9 14h.01M12 14h.01M15 14h.01M9 11h.01M12 11h.01M15 11h.01M12 21a9 9 0 110-18 9 9 0 010 18z"/></svg>Kalkulator</a>`, produksi: `<a href="#produksi" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>Produksi</a>`, 'barang-keluar': `<a href="#barang-keluar" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>Barang Keluar</a>`, input: `<a href="#input" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Input Data</a>`, master: `<a href="#master" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.58 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.58-4 8-4s8 1.79 8 4m0 0v4c0 2.21 3.58 4 8 4s8-1.79 8-4V7"/></svg>Master Data</a>`, laporan: `<a href="#laporan" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Laporan</a>`, admin: `<a href="#admin" class="nav-link flex items-center px-4 py-2 rounded-lg font-medium"><svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Admin</a>` }; navContainer.innerHTML = currentUserRole.access.map(pageId => pageMap[pageId]).join(''); };
        function showPinModal(action) { pendingAction = action; document.getElementById('pin-modal').style.display = 'flex'; document.getElementById('pin-input').focus(); };
        function hidePinModal() { document.getElementById('pin-modal').style.display = 'none'; document.getElementById('pin-form').reset(); pendingAction = null; };
        function handlePinAuth(e) { e.preventDefault(); const pin = document.getElementById('pin-input').value; if (pin === '140190') { if (pendingAction) pendingAction(); hidePinModal(); } else { showNotification('PIN salah.', true); } };
        function exportToExcel(data, fileName) { const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, fileName); };
        function showPage(hash) { const pageName = hash.substring(1) || 'dashboard'; const targetId = 'page-' + pageName; if (currentUserRole && !currentUserRole.access.includes(pageName)) { showNotification('Anda tidak memiliki akses.', true); window.location.hash = currentUserRole.access[0] || 'dashboard'; return; } document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === targetId)); document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.hash === hash || (hash === '' && l.hash === '#dashboard'))); if (['page-produksi', 'page-barang-keluar', 'page-input', 'page-kalkulator'].includes(targetId)) populateDynamicDropdowns(); if (targetId === 'page-input') renderRecipeForm(); if (targetId !== 'page-input') { resetRawMaterialForm(); resetFinishedGoodForm(); } if (targetId !== 'page-barang-keluar') resetBarangKeluarForm(); applyFiltersAndRender(); };
        function setupRealtimeListeners() { unsubscribeListeners.forEach(unsub => unsub()); unsubscribeListeners = []; const collections = { rawMaterials: d => rawMaterialsData=d, finishedGoods: d => finishedGoodsData=d, productionHistory: d => productionHistory=d, goodsOutHistory: d => goodsOutHistory=d, users: d => users=d, roles: d => roles=d, recipes: d => recipes=d, stockAddHistory: d => stockAddHistory=d }; Object.keys(collections).forEach(colName => { const unsub = onSnapshot(collection(db, colName), (snapshot) => { collections[colName](snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); if (['roles', 'users'].includes(colName)) { const user = auth.currentUser; if (user && users.length > 0 && roles.length > 0) { const userDoc = users.find(u => u.email === user.email); if (userDoc) { currentUserRole = roles.find(r => r.id === userDoc.roleId); } else { currentUserRole = null; } if (currentUserRole && !pageContentLoaded) { renderPageContent(); buildSidebarNav(); showPage(window.location.hash || '#dashboard'); mainLoader.style.display = 'none'; mainContent.classList.remove('hidden'); pageContentLoaded = true; } else if (!currentUserRole) { buildSidebarNav(); } } } applyFiltersAndRender(); populateDynamicDropdowns(); }); unsubscribeListeners.push(unsub); }); const unsubSettings = onSnapshot(doc(db, 'settings', 'appConfig'), (doc) => { if (doc.exists()) { appSettings = doc.data(); updateAppSettingsUI(); } }); unsubscribeListeners.push(unsubSettings); };
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                showApp();
                const rolesRef = collection(db, "roles");
                const rolesSnapshot = await getDocs(rolesRef);
                if (rolesSnapshot.empty) {
                    console.log("Roles collection is empty. Re-creating Admin role and user link...");
                    const allAccess = ['dashboard', 'kalkulator', 'produksi', 'barang-keluar', 'input', 'master', 'laporan', 'admin'];
                    const adminRoleRef = await addDoc(rolesRef, { name: 'Admin', access: allAccess });
                    
                    const usersRef = collection(db, "users");
                    await addDoc(usersRef, { email: user.email, roleId: adminRoleRef.id });
                    console.log(`User ${user.email} has been created and assigned as Admin.`);
                }
                
                setupRealtimeListeners();
                setupResponsiveSidebar();
            } else {
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
                currentUserRole = null;
                pageContentLoaded = false; // Reset flag on logout
                showLogin();
            }
        });
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        logoutBtn.addEventListener('click', handleLogout);
        window.addEventListener('hashchange', () => showPage(window.location.hash));
        document.getElementById('show-register-form').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        document.getElementById('show-login-form').addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        document.getElementById('pin-form').addEventListener('submit', handlePinAuth);
        document.getElementById('confirm-production-btn').addEventListener('click', executeProduction);
        document.getElementById('cancel-production-btn').addEventListener('click', () => { 
            pendingProductionData = null; 
            document.getElementById('production-confirm-modal').style.display = 'none'; 
        });
        document.getElementById('cancel-pin-btn').addEventListener('click', hidePinModal);
    </script>
</body>
</html>
